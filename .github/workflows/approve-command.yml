name: Approve Command

on:
  issue_comment:
    types: [created]

jobs:
  approve:
    name: Handle /approve command
    # Only run on pull request comments
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Check if commenter has write access
        id: check_access
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.payload.comment.user.login
              });

              const hasAccess = ['admin', 'write', 'maintain'].includes(permission.permission);
              core.setOutput('has_access', hasAccess);

              if (!hasAccess) {
                core.info(`User ${context.payload.comment.user.login} does not have sufficient permissions (${permission.permission})`);
              }

              return hasAccess;
            } catch (error) {
              core.setFailed(`Error checking permissions: ${error.message}`);
              return false;
            }

      - name: React to comment
        if: steps.check_access.outputs.has_access == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Approve PR
        if: steps.check_access.outputs.has_access == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const pr_number = context.payload.issue.number;

              // Check if the user has already approved
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number
              });

              const existingApproval = reviews.find(
                review => review.user.login === context.payload.comment.user.login &&
                          review.state === 'APPROVED'
              );

              if (existingApproval) {
                core.info(`User ${context.payload.comment.user.login} has already approved this PR`);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr_number,
                  body: '✅ You have already approved this PR.'
                });
                return;
              }

              // Create approval review
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
                event: 'APPROVE',
                body: 'Approved via /approve command'
              });

              core.info(`PR #${pr_number} approved by ${context.payload.comment.user.login}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: `✅ PR approved by @${context.payload.comment.user.login} via /approve command`
              });
            } catch (error) {
              core.setFailed(`Failed to approve PR: ${error.message}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `❌ Failed to approve PR: ${error.message}`
              });
            }

      - name: Notify insufficient permissions
        if: steps.check_access.outputs.has_access != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `❌ @${context.payload.comment.user.login} does not have sufficient permissions to approve PRs. Only maintainers and collaborators with write access can use the /approve command.`
            });
